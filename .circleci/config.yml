version: 2.1

executors:
  docker-executor:
    docker:
      - image: ghcr.io/foundry-rs/foundry:latest

jobs:
  mint-contract:
    executor: docker-executor
    parameters:
      contract-address:
        type: string
        default: "0xe1C296cb79E050EB2A52b24D9Be91f8599B32011"
      rpc-url:
        type: string
        default: "wss://optimism-sepolia-rpc.publicnode.com"
      api-url:
        type: string
        default: "http://45.146.7.38:3005/"
    steps:
      - checkout
      - run:
          name: "Generate Cache Key for jq"
          command: |
            apt-get update
            jq_version=$(apt-cache madison jq | head -n 1 | awk '{print $3}')
            echo "jq-${jq_version}" > jq-cache-key.txt
      - restore_cache:
          keys:
            - jq-dependencies-{{ checksum "jq-cache-key.txt" }}
            - jq-dependencies-
      - run:
          name: "Install jq"
          command: |
            apt-get update -y && apt-get install -y jq
      - save_cache:
          paths:
            - /var/cache/apt
            - /var/lib/apt
          key: jq-dependencies-{{ checksum "jq-cache-key.txt" }}
      - run:
          name: "Generate Cache Key for curl"
          command: |
            apt-get update
            curl_version=$(apt-cache madison curl | head -n 1 | awk '{print $3}')
            echo "curl-${curl_version}" > curl-cache-key.txt
      - restore_cache:
          keys:
            - curl-dependencies-{{ checksum "curl-cache-key.txt" }}
            - curl-dependencies-
      - run:
          name: "Install curl"
          command: |
            apt-get update -y && apt-get install -y curl
      - save_cache:
          paths:
            - /var/cache/apt
            - /var/lib/apt
          key: curl-dependencies-{{ checksum "curl-cache-key.txt" }}
      - run:
          name: "Validate Environment Variables"
          command: |
            if [ -z "$JWT_SECRET" ]; then
              echo "Error: JWT_SECRET is not set!" && exit 1
            fi
            if [ -z "$NAMESPACE" ]; then
              echo "Error: NAMESPACE is not set!" && exit 1
            fi
            echo "Environment variables are set correctly."
      - run:
          name: "Check API Connectivity"
          command: |
            if ! curl -I "<<parameters.api-url>>unique-namespace"; then
              echo "Error: API at <<parameters.api-url>> is unreachable!" && exit 1
            fi
            echo "API endpoint is reachable."
      - run:
          name: "Check Unique Namespace"
          command: |
            response=$(curl -s -w "%{http_code}" -X POST "<<parameters.api-url>>unique-namespace" \
              -H "Authorization: Bearer $JWT_SECRET" \
              -H "Content-Type: application/json" \
              -d '{"namespace":"'"$NAMESPACE"'"}')
            http_code=$(tail -n1 \<<< "$response")
            body=$(head -n-1 \<<< "$response")
            
            echo "$body" >> logs/check_unique_namespace.log
            
            if [ "$http_code" -ne 200 ]; then
              echo "Error: HTTP status $http_code while checking namespace uniqueness. Response: $body"
              exit 1
            fi

            is_unique=$(echo $body | jq -r '.unique')
            if [ "$is_unique" != "true" ]; then
              echo "Error: Namespace is not unique. Response: $body"
              exit 1
            fi
            echo "Namespace is unique. Response: $body"
      - run:
          name: "Check Unique Generated Key"
          command: |
            response=$(curl -s -w "%{http_code}" -X POST "<<parameters.api-url>>unique-generated-key" \
              -H "Authorization: Bearer $JWT_SECRET" \
              -H "Content-Type: application/json" \
              -d '{"key":"'"$NAMESPACE"'"}')
            http_code=$(tail -n1 \<<< "$response")
            body=$(head -n-1 \<<< "$response")
            
            echo "$body" >> logs/check_unique_generated_key.log
            
            if [ "$http_code" -ne 200 ]; then
              echo "Error: HTTP status $http_code while checking generated key uniqueness. Response: $body"
              exit 1
            fi

            is_unique=$(echo $body | jq -r '.unique')
            if [ "$is_unique" != "true" ]; then
              echo "Error: Generated key is not unique. Response: $body"
              exit 1
            fi
            echo "Generated key is unique. Response: $body"
      - run:
          name: "Mint Namespace Token and Save Logs"
          command: |
            cast send <<parameters.contract-address>> "safeMint(string)" "$NAMESPACE" \
              --rpc-url <<parameters.rpc-url>> \
              --private-key "$PRIVATE_KEY" | tee logs/mint_result.log
      - run:
          name: "Parse and Check Mint Result"
          command: |
            if grep -q "Transaction successful" logs/mint_result.log; then
              echo "Minting succeeded!"
            else
              echo "Minting failed. Check logs/mint_result.log for details." && exit 1
            fi
      - store_artifacts:
          path: logs/check_unique_namespace.log
          destination: unique-namespace-log

      - store_artifacts:
          path: logs/check_unique_generated_key.log
          destination: unique-generated-key-log

      - store_artifacts:
          path: logs/mint_result.log
          destination: mint-result-log

workflows:
  main-workflow:
    jobs:
      - mint-contract